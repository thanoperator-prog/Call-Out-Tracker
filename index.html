<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Call-out Tracker | Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- 1. INITIALIZE GLOBAL STATE -->
    <script>
        window.records = JSON.parse(localStorage.getItem('callout_records_v4')) || [];
        window.config = JSON.parse(localStorage.getItem('callout_config_v4')) || {
            brands: [], lols: [], los: [], ams: [], als: [], hosts: [], qas: []
        };
        window.isInitialized = false;
        window.currentLogFilter = 'All';

        // FIX: Add Toast Notification Function
        window.showToast = function(message) {
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                toast.className = 'fixed bottom-5 right-5 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[150] transform transition-all duration-300 translate-y-20 opacity-0 font-bold text-sm flex items-center gap-3';
                document.body.appendChild(toast);
            }
            toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> <span>${message}</span>`;
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            });

            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };
    </script>

    <!-- 2. FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHtoVBSfdGap9I4B7gZJi1wlMdc6CHBgc",
            authDomain: "callouttracker.firebaseapp.com",
            projectId: "callouttracker",
            storageBucket: "callouttracker.firebasestorage.app",
            messagingSenderId: "628629412234",
            appId: "1:628629412234:web:d1077eb4edfa2bdbad9073",
            measurementId: "G-TY71KC8LTQ"
        };
        
        const appId = 'callout-tracker-main-db';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Connected to Cloud:", user.uid);
                updateStatus('online');
                setupRealtimeListeners();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error:", error);
                    updateStatus('error');
                });
            }
        });

        function updateStatus(status) {
            const el = document.getElementById('connection-status');
            if(!el) return;
            if (status === 'online') {
                el.innerHTML = '<span class="flex h-3 w-3"><span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span> <span class="text-xs text-green-600 font-bold ml-2">Synced</span>';
            } else if (status === 'error') {
                el.innerHTML = '<span class="h-3 w-3 rounded-full bg-red-500"></span> <span class="text-xs text-red-600 font-bold ml-2">Error</span>';
            } else {
                el.innerHTML = '<span class="h-3 w-3 rounded-full bg-gray-400"></span> <span class="text-xs text-gray-500 font-bold ml-2">Offline</span>';
            }
        }

        function setupRealtimeListeners() {
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.config = docSnap.data();
                    localStorage.setItem('callout_config_v4', JSON.stringify(window.config));
                } else {
                    const defaultConfig = {
                         brands: ['Apple Inc', 'Google Store'],
                        lols: ['Lead John', 'Lead Sarah'],
                        los: [
                            { name: 'Operator Alex', lead: 'Lead John', brands: ['Apple Inc'] }, 
                            { name: 'Operator Bella', lead: 'Lead Sarah', brands: ['Google Store'] }
                        ],
                        ams: ['John Manager'], als: [], hosts: [], qas: []
                    };
                    setDoc(settingsRef, defaultConfig, { merge: true });
                    window.config = defaultConfig;
                }
                if(window.initSearchSelects) window.initSearchSelects(); 
                if(window.renderSettings) window.renderSettings();
                if(window.migrateReporterNames) window.migrateReporterNames();
            }, (error) => console.error("Settings Sync Error:", error));

            const recordsRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            onSnapshot(recordsRef, (snapshot) => {
                const loadedRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadedRecords.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
                window.records = loadedRecords;
                localStorage.setItem('callout_records_v4', JSON.stringify(window.records));
                window.isInitialized = true;
                if(window.migrateReporterNames) window.migrateReporterNames();
                if(window.renderAll) window.renderAll(); 
            }, (error) => console.error("Records Sync Error:", error));
        }

        window.saveFirebaseConfig = async function(newConfig) {
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), newConfig); } 
            catch(e) { console.error(e); if(window.showToast) window.showToast("Sync Failed"); }
        };

        window.addFirebaseRecord = async function(recordData) {
            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), recordData); 
                if(window.showToast) window.showToast("Synced to Cloud"); 
            } 
            catch(e) { console.error(e); if(window.showToast) window.showToast("Save Failed"); }
        };

        window.updateFirebaseRecord = async function(id, recordData, silent = false) {
            try { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', id), recordData); 
                if(!silent && window.showToast) window.showToast("Update Synced"); 
            } 
            catch(e) { console.error(e); if(!silent && window.showToast) window.showToast("Update Failed"); }
        };

        window.deleteFirebaseRecord = async function(id) {
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', id)); if(window.showToast) window.showToast("Deleted from Cloud"); } 
            catch(e) { console.error(e); if(window.showToast) window.showToast("Delete Failed"); }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; }
        .active-tab { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 700; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 100%; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 100; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 4px; max-height: 200px; overflow-y: auto; }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .dropdown-item:hover { background-color: #f1f5f9; }
        tr.clickable-row { transition: background-color 0.2s ease; }
        tr.clickable-row:hover { background-color: #f8fafc; cursor: pointer; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
        .mobile-active { color: #2563eb !important; }
        .safe-area-pb { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input { width: 16px; height: 16px; accent-color: #2563eb; cursor: pointer; }
        
        /* ROLE BASED VISIBILITY */
        body.role-operator .admin-only { display: none !important; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-800 min-h-screen pb-24 lg:pb-0">

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-2">
                    <div class="p-2 bg-blue-600 rounded-lg shadow-lg shadow-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">Call-out Tracker</span>
                        <div id="connection-status" class="flex items-center">
                            <span class="h-2 w-2 rounded-full bg-gray-300"></span> <span class="text-[10px] text-gray-400 ml-1">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="hidden lg:flex space-x-10">
                    <button onclick="showSection('dashboard')" class="nav-link py-7 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-all">Dashboard</button>
                    <button onclick="showSection('record-log')" class="nav-link py-7 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-all">Record Log</button>
                    <button onclick="showSection('settings')" class="nav-link py-7 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-all admin-only">Settings</button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportToExcel()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 sm:px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-xl shadow-green-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span class="hidden sm:inline">Export</span>
                    </button>
                    <button onclick="logout()" class="p-2.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Nav -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around pt-3 z-[999] shadow-[0_-4px_20px_rgba(0,0,0,0.1)] safe-area-pb">
        <button id="mob-dashboard" onclick="showSection('dashboard')" class="mobile-nav-btn flex flex-col items-center justify-center w-full py-1 text-[10px] font-bold text-slate-400 mobile-active hover:bg-slate-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" /></svg>
            Dashboard
        </button>
        <button id="mob-record-log" onclick="showSection('record-log')" class="mobile-nav-btn flex flex-col items-center justify-center w-full py-1 text-[10px] font-bold text-slate-400 hover:bg-slate-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            Log
        </button>
        <button id="mob-settings" onclick="showSection('settings')" class="mobile-nav-btn flex flex-col items-center justify-center w-full py-1 text-[10px] font-bold text-slate-400 hover:bg-slate-50 transition-colors admin-only">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Settings
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 mb-24 lg:mb-0">
        <!-- SECTION: DASHBOARD -->
        <section id="dashboard" class="space-y-8 animate-in fade-in duration-500">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900">Operations Analytics</h1>
                    <p class="text-slate-500 mt-1">Real-time overview. Click any record to view details.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                        <label for="dashboard-filter" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Filter:</label>
                        <select id="dashboard-filter" onchange="handleDashboardFilterChange()" class="bg-transparent text-sm font-bold text-blue-600 outline-none cursor-pointer">
                            <option value="overall">Overall (All Time)</option>
                            <option value="current_month">Current Month</option>
                            <option value="specific_month">Select Month & Year</option>
                        </select>
                    </div>
                    <input type="month" id="dashboard-month-picker" onchange="renderDashboard()" class="hidden bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest" id="label-total">Lifetime Total</p>
                    <p id="stat-total" class="text-4xl font-black text-blue-600 mt-2">0</p>
                </div>
                <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Today's Active (PHT)</p>
                    <p id="stat-today" class="text-4xl font-black text-orange-500 mt-2">0</p>
                </div>
                <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Top Flagged Brand</p>
                    <p id="stat-brand" class="text-xl font-bold text-slate-800 mt-2 truncate">-</p>
                </div>
                <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Lead Reporter</p>
                    <p id="stat-who" class="text-xl font-bold text-slate-800 mt-2 truncate">-</p>
                </div>
            </div>

            <!-- Coaching Priority Widget -->
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col">
                <div class="px-8 py-6 border-b border-slate-50 bg-red-50/30 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-red-100 rounded-lg text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <div>
                            <h2 class="font-extrabold text-slate-900">Coaching Priority</h2>
                            <p class="text-[10px] font-bold text-red-500 uppercase tracking-wide">High Frequency Call-outs</p>
                        </div>
                    </div>
                    <span id="coaching-period-label" class="text-[10px] font-bold text-slate-400 bg-white px-2 py-1 rounded border border-slate-100">Overall</span>
                </div>
                <div id="coaching-list" class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Coaching items injected here -->
                </div>
            </div>

            <!-- Recent Operational Activity -->
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col">
                <div class="px-8 py-6 border-b border-slate-50">
                    <h2 class="font-extrabold text-slate-900">Recent Operational Activity</h2>
                </div>
                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50/50 text-slate-400 uppercase text-[10px] font-black tracking-widest">
                            <tr>
                                <th class="px-8 py-4">Time (PHT)</th>
                                <th class="px-8 py-4">Brand</th>
                                <th class="px-8 py-4">Reporter</th>
                                <th class="px-8 py-4">Reason</th>
                                <th class="px-8 py-4 text-right">Team</th>
                            </tr>
                        </thead>
                        <tbody id="recent-table-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION: RECORD LOG -->
        <section id="record-log" class="hidden space-y-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900">History Log</h1>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                        <label for="log-date-filter" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Filter:</label>
                        <select id="log-date-filter" onchange="handleLogDateFilterChange()" class="bg-transparent text-sm font-bold text-blue-600 outline-none cursor-pointer">
                            <option value="overall">All Time</option>
                            <option value="current_month">Current Month</option>
                            <option value="specific_month">Select Month</option>
                        </select>
                    </div>
                    <input type="month" id="log-month-picker" onchange="renderLogs(); renderLogTabs();" class="hidden bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="openCalloutModal()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-bold shadow-xl shadow-blue-100 flex items-center justify-center gap-2 admin-only">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        New Log
                    </button>
                </div>
            </div>

            <div id="lol-filter-container" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"></div>

            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] font-black tracking-widest">
                            <tr>
                                <th class="px-6 py-4">Evidence</th>
                                <th class="px-6 py-4">Timeline</th>
                                <th class="px-6 py-4">Details</th>
                                <th class="px-6 py-4">Lead Remarks</th>
                                <th class="px-6 py-4 text-center">Manage</th>
                            </tr>
                        </thead>
                        <tbody id="full-log-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION: SETTINGS -->
        <section id="settings" class="hidden space-y-10">
            <!-- (Settings content remains unchanged for brevity, but is preserved in logic) -->
            <h1 class="text-3xl font-extrabold text-slate-900">Global Settings</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-3 flex lg:flex-col gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="switchSettingsTab('brand')" id="tab-brand" class="setting-tab flex-1 lg:flex-none text-left px-5 py-3.5 rounded-2xl font-bold text-sm bg-blue-50 text-blue-600 whitespace-nowrap">Brands</button>
                    <button onclick="switchSettingsTab('leads')" id="tab-leads" class="setting-tab flex-1 lg:flex-none text-left px-5 py-3.5 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50 whitespace-nowrap">Operator Leads</button>
                    <button onclick="switchSettingsTab('operators')" id="tab-operators" class="setting-tab flex-1 lg:flex-none text-left px-5 py-3.5 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50 whitespace-nowrap">Mapping</button>
                    <button onclick="switchSettingsTab('roles')" id="tab-roles" class="setting-tab flex-1 lg:flex-none text-left px-5 py-3.5 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50 whitespace-nowrap">Personnel (Roles)</button>
                    <button onclick="switchSettingsTab('backup')" id="tab-backup" class="setting-tab flex-1 lg:flex-none text-left px-5 py-3.5 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50 whitespace-nowrap">Backup & Restore</button>
                </div>

                <div class="lg:col-span-9 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 min-h-[500px]">
                    <!-- Brand -->
                    <div id="set-brand" class="setting-panel space-y-6">
                        <h3 class="text-xl font-bold">Brand Portfolio</h3>
                        <div class="flex gap-3">
                            <input type="text" id="new-brand" placeholder="Add Brand" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-blue-500">
                            <button onclick="addItem('brands', 'new-brand')" class="bg-blue-600 text-white px-6 rounded-xl font-bold text-lg hover:bg-blue-700">+</button>
                        </div>
                        <ul id="list-brands" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></ul>
                    </div>

                    <!-- Leads -->
                    <div id="set-leads" class="setting-panel hidden space-y-6">
                        <h3 class="text-xl font-bold">Live Operator Management</h3>
                        <div class="flex gap-3">
                            <input type="text" id="new-lol" placeholder="Add Lead Name" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-blue-500">
                            <button onclick="addItem('lols', 'new-lol')" class="bg-blue-600 text-white px-6 rounded-xl font-bold text-lg hover:bg-blue-700">+</button>
                        </div>
                        <ul id="list-lols" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></ul>
                    </div>

                    <!-- Mapping -->
                    <div id="set-operators" class="setting-panel hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold">Assign Personnel</h3>
                            <p class="text-xs text-slate-400 font-medium italic">Tip: Click pencil icon to edit brands</p>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 space-y-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Create New Operator</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <input type="text" id="new-lo-name" placeholder="Operator Name" class="bg-white border-0 rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-blue-500 shadow-sm">
                                <select id="new-lo-lead" class="bg-white border-0 rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-blue-500 shadow-sm"></select>
                            </div>
                            <!-- Brand Checklist for New Operator -->
                            <div class="bg-white p-3 rounded-xl border border-slate-100">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Assign Brands (Optional)</label>
                                <div id="brand-checklist" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                                    <!-- Checkboxes injected by JS -->
                                </div>
                            </div>
                            <button onclick="addOperatorRelationship()" id="btn-save-operator" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">Create Operator</button>
                        </div>

                        <div class="pt-2"><div id="list-los" class="space-y-6"></div></div>
                    </div>

                    <!-- Roles Personnel -->
                    <div id="set-roles" class="setting-panel hidden space-y-8">
                        <h3 class="text-xl font-bold">Role-Based Personnel</h3>
                        <div class="grid grid-cols-1 gap-8">
                            <!-- AM List -->
                            <div class="space-y-4">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Account Managers</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-am-name" placeholder="New AM Name" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm">
                                    <button onclick="addItem('ams', 'new-am-name')" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">+</button>
                                </div>
                                <ul id="list-ams" class="flex flex-wrap gap-2"></ul>
                            </div>
                            <!-- AL List -->
                            <div class="space-y-4">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Account Leads</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-al-name" placeholder="New AL Name" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm">
                                    <button onclick="addItem('als', 'new-al-name')" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">+</button>
                                </div>
                                <ul id="list-als" class="flex flex-wrap gap-2"></ul>
                            </div>
                            <!-- Host List -->
                            <div class="space-y-4">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Live Hosts</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-host-name" placeholder="New Host Name" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm">
                                    <button onclick="addItem('hosts', 'new-host-name')" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">+</button>
                                </div>
                                <ul id="list-hosts" class="flex flex-wrap gap-2"></ul>
                            </div>
                            <!-- QA List -->
                            <div class="space-y-4">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Quality Assurance</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-qa-name" placeholder="New QA Name" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm">
                                    <button onclick="addItem('qas', 'new-qa-name')" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">+</button>
                                </div>
                                <ul id="list-qas" class="flex flex-wrap gap-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Backup & Restore Panel -->
                    <div id="set-backup" class="setting-panel hidden space-y-8">
                        <h3 class="text-xl font-bold">Data Management</h3>
                        
                        <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 space-y-4">
                            <div>
                                <h4 class="text-sm font-bold text-slate-900">Backup Data</h4>
                                <p class="text-xs text-slate-500 mt-1">Download a copy of all your records and settings to your device.</p>
                            </div>
                            <button onclick="backupData()" class="w-full sm:w-auto bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-black transition-all shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Download Backup
                            </button>
                        </div>

                        <div class="bg-red-50 p-6 rounded-[2rem] border border-red-100 space-y-4">
                            <div>
                                <h4 class="text-sm font-bold text-red-900">Restore Data</h4>
                                <p class="text-xs text-red-500 mt-1">Upload a backup file to restore your data. <strong>Warning: This will replace all current data.</strong></p>
                            </div>
                            <div class="flex gap-2">
                                <input type="file" id="restore-file" accept=".json" class="flex-1 bg-white border-0 rounded-xl px-4 py-3 text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-[10px] file:font-bold file:bg-red-100 file:text-red-700">
                                <button onclick="restoreData()" class="bg-red-600 text-white px-6 rounded-xl font-bold text-sm hover:bg-red-700 shadow-lg shadow-red-200">Restore</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- NEW: View Record Modal -->
    <div id="view-record-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden z-[60] flex items-center justify-center p-4 modal-overlay opacity-0">
        <div class="bg-white rounded-[2.5rem] w-full max-w-4xl overflow-hidden shadow-2xl modal-container opacity-0 scale-90 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-3">
                     <div class="p-2 bg-blue-100 text-blue-600 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                     </div>
                    <div>
                        <h2 class="text-xl font-black text-slate-900 tracking-tight">Incident Details</h2>
                        <p id="view-id-display" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">REF-ID</p>
                    </div>
                </div>
                <button onclick="toggleModal('view-record-modal', false)" class="text-slate-400 hover:text-slate-600 p-2 bg-white rounded-full shadow-sm">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Details -->
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Timestamp</label>
                                <div id="view-date" class="text-sm font-bold text-slate-800"></div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Brand</label>
                                <div id="view-brand" class="text-sm font-bold text-slate-800"></div>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                             <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Reporting Person</label>
                             <div id="view-who" class="text-sm font-bold text-slate-800"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div class="p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100">
                                <label class="text-[9px] font-black text-indigo-300 uppercase tracking-widest block mb-1">Team Lead(s)</label>
                                <div id="view-lol" class="text-xs font-bold text-indigo-700"></div>
                            </div>
                             <div class="p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
                                <label class="text-[9px] font-black text-blue-300 uppercase tracking-widest block mb-1">Operator(s)</label>
                                <div id="view-lo" class="text-xs font-bold text-blue-700"></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Incident Reason</label>
                                <div id="view-reason" class="p-5 bg-white rounded-2xl border border-slate-200 text-sm text-slate-600 leading-relaxed shadow-sm"></div>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Corrective Remarks</label>
                                <div id="view-remarks" class="p-5 bg-yellow-50/50 rounded-2xl border border-yellow-100 text-sm text-slate-600 leading-relaxed shadow-sm"></div>
                            </div>
                        </div>

                        <!-- NEW: Dispute Section -->
                        <div id="dispute-ui-section" class="pt-4 border-t border-slate-100"></div>
                    </div>

                    <!-- Right Column: Evidence -->
                    <div class="flex flex-col h-full">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Evidence / Proof</label>
                        <div id="view-image-container" class="flex-1 bg-slate-900 rounded-3xl overflow-hidden relative group min-h-[300px] flex items-center justify-center border-4 border-white shadow-xl">
                            <img id="view-image" src="" class="max-w-full max-h-full object-contain cursor-zoom-in transition-transform duration-300" onclick="viewImage(this.src)">
                            <div id="view-no-image" class="text-slate-500 font-bold text-xs">No Image Provided</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-50/80 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="toggleModal('view-record-modal', false)" class="px-8 py-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-500 hover:bg-slate-50 hover:text-slate-700 transition-all">Close Window</button>
                <button id="view-edit-btn" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all flex items-center gap-2 admin-only">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    Edit Record
                </button>
            </div>
        </div>
    </div>

    <!-- Edit/Add Log Modal -->
    <div id="callout-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 modal-overlay opacity-0">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl modal-container opacity-0 scale-90">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <h2 id="modal-title" class="text-2xl font-black text-slate-900 tracking-tight">Post Log</h2>
                <button onclick="toggleModal('callout-modal', false)" class="text-slate-400 hover:text-slate-600 p-2 bg-white rounded-full shadow-sm">&times;</button>
            </div>
            <form id="callout-form" class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="edit-index" value="-1">
                
                <!-- NEW: Dispute Toggle (Admin Only) -->
                <div class="admin-only bg-red-50 p-4 rounded-2xl border border-red-100 flex items-start gap-3">
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5">
                            <input id="form-disputed" name="isDisputed" type="checkbox" class="w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500 cursor-pointer">
                        </div>
                    </div>
                    <div class="ml-1 text-sm">
                        <label for="form-disputed" class="font-bold text-red-700 cursor-pointer">Mark as Disputed / Valid Explanation</label>
                        <p class="text-xs text-red-500 mt-1">If checked, this record will be <strong>excluded</strong> from all statistics and coaching counts.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Timestamp (PHT)</label>
                        <input type="datetime-local" id="form-datetime" name="datetime" required class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm">
                    </div>
                    <div class="space-y-2" id="brand-select-container">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Target Brand</label>
                    </div>
                    <div class="space-y-2" id="reporter-select-container">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Reporting Person</label>
                    </div>
                    <div class="space-y-2" id="lol-select-container">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Team Lead</label>
                    </div>
                    <div class="space-y-2" id="lo-select-container">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Assigned Operator</label>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Evidence Upload</label>
                        <input type="file" id="form-proof" accept="image/*" class="w-full text-xs text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:bg-blue-600 file:text-white file:font-bold">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Incident Reason</label>
                    <textarea name="reason" id="form-reason" required rows="3" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm" placeholder="Details of the call-out..."></textarea>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Corrective Remarks</label>
                    <textarea name="remarks" id="form-remarks" rows="2" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm" placeholder="Feedback from Lead..."></textarea>
                </div>
            </form>
            <div class="p-8 bg-slate-50/50 border-t border-slate-100 flex gap-4">
                <button type="button" onclick="toggleModal('callout-modal', false)" id="modal-cancel-btn" class="flex-1 py-4 border-2 border-slate-200 rounded-2xl font-bold text-slate-500">Cancel</button>
                <button type="submit" form="callout-form" id="modal-submit-btn" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100">Confirm Log</button>
            </div>
        </div>
    </div>
    
    <!-- Search Select Template -->
    <div id="search-select-template" class="hidden">
        <div class="relative w-full custom-search-select" data-id="">
            <div class="flex items-center justify-between w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm cursor-pointer select-btn border border-transparent hover:border-slate-200">
                <span class="selected-text text-slate-400">Select...</span>
                <svg class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" /></svg>
            </div>
            <div class="dropdown-content">
                <div class="p-2 sticky top-0 bg-white border-b border-slate-50">
                    <input type="text" placeholder="Type to search..." class="w-full bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-blue-500 dropdown-search">
                </div>
                <div class="items-list pb-1"></div>
            </div>
        </div>
    </div>

    <!-- Edit Operator Modal -->
    <div id="edit-operator-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4 modal-overlay opacity-0">
        <div class="bg-white rounded-[2rem] w-full max-w-lg overflow-hidden shadow-2xl modal-container opacity-0 scale-90">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-xl font-black text-slate-900">Edit Operator</h2>
                <button onclick="toggleModal('edit-operator-modal', false)" class="text-slate-400 hover:text-slate-600 p-2 bg-white rounded-full shadow-sm">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <input type="hidden" id="edit-op-original-name">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Operator Name</label>
                    <input type="text" id="edit-op-name" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Team Lead</label>
                    <select id="edit-op-lead" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Assigned Brands</label>
                        <input type="text" id="brand-search-edit" oninput="filterBrandCheckboxes('brand-search-edit', 'edit-op-brands')" placeholder="Search brands..." class="bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs focus:ring-1 focus:ring-blue-500 w-1/3">
                    </div>
                    <div id="edit-op-brands" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <!-- Checkboxes will be injected here -->
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50/50 border-t border-slate-100 flex gap-3">
                <button onclick="toggleModal('edit-operator-modal', false)" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500">Cancel</button>
                <button onclick="saveOperatorChanges()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="app-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4 modal-overlay opacity-0">
        <div class="bg-white rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl modal-container opacity-0 scale-90 p-8 space-y-6 text-center">
            <div id="app-modal-icon" class="flex justify-center"></div>
            <div class="space-y-2">
                <h3 id="app-modal-title" class="text-xl font-extrabold text-slate-900">Confirm Action</h3>
                <p id="app-modal-message" class="text-sm text-slate-500 font-medium">Are you sure?</p>
            </div>
            <div id="app-modal-actions" class="flex gap-3 pt-2"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex p-3 bg-blue-100 text-blue-600 rounded-2xl mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h1 class="text-2xl font-black text-slate-900">Call-out Tracker</h1>
                <p class="text-slate-500 font-bold text-sm mt-1">Please identify your role</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Select Role</label>
                    <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-xl">
                        <button onclick="selectRole('operator')" id="btn-role-operator" class="py-3 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm">Operator</button>
                        <button onclick="selectRole('admin')" id="btn-role-admin" class="py-3 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600">Operations Lead</button>
                    </div>
                </div>

                <div id="password-field" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Access Password</label>
                    <input type="password" id="login-password" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3.5 text-sm font-bold text-slate-900 focus:ring-2 focus:ring-blue-500" placeholder="Enter password...">
                </div>

                <button onclick="attemptLogin()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all mt-4">
                    Access System
                </button>
            </div>
        </div>
    </div>

    <!-- 3. MAIN SCRIPT (Uses window variables directly) -->
    <script>
        // --- LOGIN LOGIC ---
        let selectedRole = 'operator';

        function selectRole(role) {
            selectedRole = role;
            const btnOp = document.getElementById('btn-role-operator');
            const btnAd = document.getElementById('btn-role-admin');
            const passField = document.getElementById('password-field');
            const passInput = document.getElementById('login-password');

            if (role === 'operator') {
                btnOp.className = "py-3 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm";
                btnAd.className = "py-3 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600";
                passField.classList.add('hidden');
                passInput.value = '';
            } else {
                btnAd.className = "py-3 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm";
                btnOp.className = "py-3 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600";
                passField.classList.remove('hidden');
                passInput.focus();
            }
        }

        function attemptLogin() {
            if (selectedRole === 'operator') {
                completeLogin('operator');
            } else {
                const pass = document.getElementById('login-password').value;
                if (pass === 'leads123') {
                    completeLogin('admin');
                } else {
                    if(window.showToast) window.showToast("Incorrect Password");
                    else alert("Incorrect Password");
                    const passInput = document.getElementById('login-password');
                    passInput.classList.add('ring-2', 'ring-red-500');
                    setTimeout(() => passInput.classList.remove('ring-2', 'ring-red-500'), 500);
                }
            }
        }

        window.logout = function() {
            document.body.classList.remove('role-admin', 'role-operator');
            const modal = document.getElementById('login-modal');
            modal.classList.remove('hidden');
            // Slight delay to ensure 'hidden' is removed before opacity transition kicks in (if needed), 
            // but primarily just ensuring it's visible.
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0', 'pointer-events-none');
            });
            
            // Reset state
            document.getElementById('login-password').value = '';
            selectRole('operator'); 
            
            if(window.showToast) window.showToast("Logged out");
        };

        function completeLogin(role) {
            document.body.classList.remove('role-admin', 'role-operator');
            document.body.classList.add(role === 'admin' ? 'role-admin' : 'role-operator');
            
            // Hide modal
            const modal = document.getElementById('login-modal');
            modal.classList.add('opacity-0', 'pointer-events-none', 'transition-opacity', 'duration-500');
            setTimeout(() => modal.classList.add('hidden'), 500);
            
            if(window.showToast) window.showToast(`Logged in as ${role === 'admin' ? 'Lead' : 'Operator'}`);
        }

        // --- 2. MODAL & SEARCH LOGIC ---
        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if(!el) return;
            const container = el.querySelector('.modal-container');
            
            if (show) {
                el.classList.remove('hidden');
                // Allow browser paint to process removal of hidden before applying opacity transition
                requestAnimationFrame(() => {
                    el.classList.remove('opacity-0');
                    if(container) {
                        container.classList.remove('scale-90', 'opacity-0');
                    }
                });
            } else {
                el.classList.add('opacity-0');
                if(container) {
                    container.classList.add('scale-90', 'opacity-0');
                }
                setTimeout(() => {
                    el.classList.add('hidden');
                }, 300);
            }
        }
        
        window.toggleModal = toggleModal; // EXPLICITLY ATTACH TO WINDOW

        const AppModal = {
            resolve: null,
            show(title, message, type = 'confirm') {
                return new Promise((res) => {
                    this.resolve = res;
                    const overlay = document.getElementById('app-modal');
                    const container = overlay.querySelector('.modal-container');
                    const actions = document.getElementById('app-modal-actions');
                    const iconCont = document.getElementById('app-modal-icon');
                    
                    document.getElementById('app-modal-title').innerText = title;
                    document.getElementById('app-modal-message').innerText = message;
                    
                    iconCont.innerHTML = type === 'confirm' ? 
                        `<div class="p-4 bg-blue-50 text-blue-600 rounded-full"><svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>` : 
                        `<div class="p-4 bg-green-50 text-green-600 rounded-full"><svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div>`;

                    actions.innerHTML = type === 'confirm' ? 
                        `<button onclick="AppModal.handle(false)" class="flex-1 py-3 border border-slate-100 rounded-xl font-bold text-slate-400">Cancel</button><button onclick="AppModal.handle(true)" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">Proceed</button>` : 
                        `<button onclick="AppModal.handle(true)" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold">Okay</button>`;

                    overlay.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        overlay.classList.remove('opacity-0');
                        container.classList.remove('scale-90', 'opacity-0');
                    });
                });
            },
            handle(value) {
                const overlay = document.getElementById('app-modal');
                const container = overlay.querySelector('.modal-container');
                overlay.classList.add('opacity-0');
                container.classList.add('scale-90', 'opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    this.resolve(value);
                }, 300);
            }
        };

        const roleCategories = [
            { id: 'ams', label: 'Account Manager' },
            { id: 'als', label: 'Account Lead' },
            { id: 'hosts', label: 'Live Host' },
            { id: 'qas', label: 'Quality Assurance' }
        ];

        const customSelects = {
            brand: null,
            reporter: null,
            lol: null,
            lo: null
        };

        // --- Select & Filter Logic ---
        function buildSearchSelect(containerId, options, initialValue = '', onSelect = null, isMulti = false) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            let selectDiv = container.querySelector('.custom-search-select');
            let isNew = false;
            // Internal state for multi
            let selectedMulti = [];

            if (!selectDiv) {
                const template = document.getElementById('search-select-template').cloneNode(true);
                selectDiv = template.querySelector('.custom-search-select');
                const label = container.querySelector('label');
                container.innerHTML = ''; 
                if (label) container.appendChild(label);
                container.appendChild(selectDiv);
                isNew = true;
            }
            const searchInput = selectDiv.querySelector('.dropdown-search');
            const listContainer = selectDiv.querySelector('.items-list');
            const selectBtn = selectDiv.querySelector('.select-btn');
            const selectedText = selectDiv.querySelector('.selected-text');
            
            // Handle Initial Value
            if (isMulti) {
                selectedMulti = Array.isArray(initialValue) ? initialValue : (initialValue ? [initialValue] : []);
                updateMultiDisplay();
            } else {
                selectDiv.dataset.value = initialValue;
                if(initialValue) { selectedText.innerText = initialValue; selectedText.classList.remove('text-slate-400'); } 
                else { selectedText.innerText = "Select..."; selectedText.classList.add('text-slate-400'); }
            }

            function updateMultiDisplay() {
                if (selectedMulti.length === 0) {
                    selectedText.innerText = "Select Operators...";
                    selectedText.classList.add('text-slate-400');
                } else {
                    selectedText.innerText = selectedMulti.join(', ');
                    selectedText.classList.remove('text-slate-400');
                }
                selectDiv.dataset.value = JSON.stringify(selectedMulti);
            }

            const renderList = (filter = '') => {
                listContainer.innerHTML = '';
                const filtered = options.filter(o => o.label.toLowerCase().includes(filter.toLowerCase()));
                if(filtered.length === 0) { listContainer.innerHTML = `<div class="p-4 text-xs text-slate-400 italic text-center">No results</div>`; return; }
                filtered.forEach(o => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    
                    if (isMulti) {
                        const isSelected = selectedMulti.includes(o.label);
                        item.innerHTML = `
                            <div class="flex items-center gap-2">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} class="pointer-events-none form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300">
                                <span class="text-sm text-slate-700">${o.label}</span>
                            </div>
                        `;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            if (selectedMulti.includes(o.label)) {
                                selectedMulti = selectedMulti.filter(v => v !== o.label);
                            } else {
                                selectedMulti.push(o.label);
                            }
                            updateMultiDisplay();
                            renderList(searchInput.value);
                            if(onSelect) onSelect(selectedMulti);
                        };
                    } else {
                        item.innerHTML = o.isCategory ? `<div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${o.label}</div>` : o.label;
                        if(!o.isCategory) {
                            item.onclick = (e) => {
                                e.stopPropagation();
                                selectDiv.dataset.value = o.label;
                                selectedText.innerText = o.label;
                                selectedText.classList.remove('text-slate-400');
                                selectDiv.querySelector('.dropdown-content').classList.remove('show');
                                if(onSelect) onSelect(o.label);
                            };
                        } else { item.classList.add('bg-slate-50', 'pointer-events-none', 'mt-2', 'first:mt-0'); }
                    }
                    listContainer.appendChild(item);
                });
            };

            if (isNew) {
                selectBtn.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.dropdown-content').forEach(d => { if(d !== selectDiv.querySelector('.dropdown-content')) d.classList.remove('show'); });
                    selectDiv.querySelector('.dropdown-content').classList.toggle('show');
                    searchInput.focus();
                    renderList('');
                };
                searchInput.oninput = (e) => renderList(e.target.value);
            }
            return {
                getValue: () => isMulti ? JSON.parse(selectDiv.dataset.value || '[]') : selectDiv.dataset.value,
                setValue: (val) => {
                    if (isMulti) {
                        selectedMulti = Array.isArray(val) ? val : (val ? [val] : []);
                        updateMultiDisplay();
                    } else {
                        selectDiv.dataset.value = val;
                        selectedText.innerText = val || 'Select...';
                        if(!val) selectedText.classList.add('text-slate-400'); else selectedText.classList.remove('text-slate-400');
                    }
                },
                refresh: (newOptions) => { options = newOptions; renderList(''); }
            };
        }
        window.onclick = () => { document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); };

        // --- Main Init ---
        window.onload = () => {
            try {
                if(window.config.los) window.config.los.forEach(lo => { if(!lo.brands) lo.brands = []; });
                initSearchSelects();
                renderAll();
                showSection('dashboard');
                window.isInitialized = true;
            } catch (e) { console.error("Init Error:", e); }
        };

        function getPHTISOString() {
            const formatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Manila', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
            const p = formatter.formatToParts(new Date()).reduce((acc, v) => ({...acc, [v.type]: v.value}), {});
            return `${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}`;
        }

        // --- Business Logic ---
        function initSearchSelects() {
            if(!window.config) return;
            
            const brandOpts = (window.config.brands || []).sort().map(b => ({ label: b }));
            if (customSelects.brand) customSelects.brand.refresh(brandOpts);
            else customSelects.brand = buildSearchSelect('brand-select-container', brandOpts, '', (brandName) => autoSelectOperatorByBrand(brandName));

            const reporterOpts = [];
            roleCategories.forEach(cat => {
                const names = [...(window.config[cat.id] || [])].sort();
                if(names.length > 0) {
                    reporterOpts.push({ label: cat.label, isCategory: true });
                    names.forEach(n => reporterOpts.push({ label: `[${cat.label}] ${n}` }));
                }
            });
            if (customSelects.reporter) customSelects.reporter.refresh(reporterOpts);
            else customSelects.reporter = buildSearchSelect('reporter-select-container', reporterOpts);

            const leadOpts = (window.config.lols || []).sort().map(l => ({ label: l }));
            if (customSelects.lol) customSelects.lol.refresh(leadOpts);
            else customSelects.lol = buildSearchSelect('lol-select-container', leadOpts, '', (val) => refreshOperatorSelect(val), true); // MULTI SELECT for Team Lead

            if (customSelects.lo) customSelects.lo.refresh([]);
            else customSelects.lo = buildSearchSelect('lo-select-container', [], [], null, true); // MULTI SELECT for Operator
        }

        function refreshOperatorSelect(leadNames) {
            // leadNames can be array or string
            const leads = Array.isArray(leadNames) ? leadNames : (leadNames ? [leadNames] : []);
            
            const filtered = window.config.los
                .filter(o => leads.includes(o.lead))
                .sort((a,b) => a.name.localeCompare(b.name))
                .map(o => ({ label: o.name }));
                
            if(customSelects.lo) { 
                customSelects.lo.refresh(filtered); 
                customSelects.lo.setValue([]); 
            }
        }

        function autoSelectOperatorByBrand(brandName) {
            const assignedOps = window.config.los.filter(o => o.brands && o.brands.includes(brandName));
            
            if (assignedOps.length > 0) {
                const uniqueLeads = [...new Set(assignedOps.map(o => o.lead))];
                
                // Always set Leads (works for single or multiple)
                if (customSelects.lol) customSelects.lol.setValue(uniqueLeads);
                
                // Show all operators for these leads
                refreshOperatorSelect(uniqueLeads);
                
                // Optionally refine operator selection if only specific ones match the brand
                 const brandSpecificOpNames = assignedOps.map(o => o.name);
                 
                if (customSelects.lo) {
                   // If only 1 specific op matches, select them. Otherwise leave blank filtered list.
                    if (brandSpecificOpNames.length === 1) {
                         customSelects.lo.setValue(brandSpecificOpNames);
                         if(window.showToast) window.showToast("Auto-selected operator.");
                    } else {
                        customSelects.lo.setValue([]);
                        if(window.showToast) window.showToast("Filtered by brand. Please select operators.");
                    }
                }
            } else {
                if (customSelects.lol) customSelects.lol.setValue([]);
                if (customSelects.lo) { customSelects.lo.refresh([]); customSelects.lo.setValue([]); }
            }
        }

        function migrateReporterNames() {
            if (!window.records || window.records.length === 0) return;
            
            let updates = 0;
            // Iterate and update records in memory first
            window.records.forEach(r => {
                if (r.who && !r.who.startsWith('[')) {
                    // Try to find the role
                    for (const cat of roleCategories) {
                        if (window.config[cat.id] && window.config[cat.id].includes(r.who)) {
                            const newWho = `[${cat.label}] ${r.who}`;
                            if (r.who !== newWho) {
                                // Update local record
                                r.who = newWho;
                                updates++;
                                // Update Firebase silently if ID exists
                                if (r.id && window.updateFirebaseRecord) {
                                    window.updateFirebaseRecord(r.id, { who: newWho }, true);
                                }
                            }
                            break; 
                        }
                    }
                }
            });

            if (updates > 0) {
                console.log(`Migrated ${updates} reporter names.`);
                // Refresh UI to show new names immediately
                if(window.renderAll) window.renderAll();
            }
        }

        // --- ACTIONS (Using window.config/records) ---
        
        // NEW: View Record Logic (Dedicated View Window)
        window.viewRecord = function(index) {
            const r = window.records[index];
            if(!r) return;

            // Handle Dispute Badge
            const idDisplay = document.getElementById('view-id-display');
            if(r.isDisputed) {
                idDisplay.innerHTML = `<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-black mr-2">DISPUTED / VOID</span> ${r.id ? `REF: ${r.id.slice(-6).toUpperCase()}` : 'LOCAL RECORD'}`;
            } else {
                idDisplay.innerText = r.id ? `REF: ${r.id.slice(-6).toUpperCase()}` : 'LOCAL RECORD';
            }

            document.getElementById('view-date').innerText = new Date(r.datetime).toLocaleString('en-US', { timeZone: 'Asia/Manila', dateStyle: 'full', timeStyle: 'medium' });
            document.getElementById('view-brand').innerText = r.brand || '-';
            document.getElementById('view-who').innerText = r.who || '-';
            document.getElementById('view-lol').innerText = Array.isArray(r.lol) ? r.lol.join(', ') : (r.lol || '-');
            document.getElementById('view-lo').innerText = Array.isArray(r.lo) ? r.lo.join(', ') : (r.lo || '-');
            document.getElementById('view-reason').innerText = r.reason || 'No details provided.';
            document.getElementById('view-remarks').innerText = r.remarks || 'No remarks provided.';

            // --- Dispute Section Logic ---
            const disputeUI = document.getElementById('dispute-ui-section');
            const isAdmin = document.body.classList.contains('role-admin');
            let disputeHtml = '';

            // Status Logic: 'pending' | 'approved' | 'rejected' | or none
            if (r.disputeStatus === 'pending') {
                disputeHtml += `<div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-4 animate-in fade-in slide-in-from-bottom-2">
                    <div class="flex items-start gap-3">
                        <div class="p-2 bg-orange-100 text-orange-600 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-orange-700 text-xs uppercase mb-1">Dispute Pending Review</h4>
                            <p class="text-sm text-slate-600 italic bg-white p-3 rounded-lg border border-orange-100">"${r.disputeReason}"</p>
                            ${isAdmin ? `
                            <div class="flex gap-2 mt-3">
                                <button onclick="window.resolveDispute(${index}, true)" class="px-4 py-2 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-sm transition-all flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                                    Approve (Void Record)
                                </button>
                                <button onclick="window.resolveDispute(${index}, false)" class="px-4 py-2 bg-white border border-red-200 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 shadow-sm transition-all">Reject Dispute</button>
                            </div>
                            ` : `<p class="text-[10px] text-orange-400 mt-2 font-bold">Waiting for Operations Lead to review.</p>`}
                        </div>
                    </div>
                </div>`;
            } else if (r.disputeStatus === 'approved') {
                disputeHtml += `<div class="bg-green-50 p-4 rounded-xl border border-green-100 mb-4 flex items-center gap-3">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-green-700 text-xs uppercase">Dispute Approved</h4>
                        <p class="text-[10px] text-green-600 font-bold">This record has been voided and excluded from stats.</p>
                    </div>
                </div>`;
            } else if (r.disputeStatus === 'rejected') {
                 disputeHtml += `<div class="bg-red-50 p-4 rounded-xl border border-red-100 mb-4 flex items-center gap-3">
                    <div class="p-2 bg-red-100 text-red-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-red-700 text-xs uppercase">Dispute Rejected</h4>
                        <p class="text-[10px] text-red-600 font-bold">The dispute was reviewed and denied. Record remains active.</p>
                    </div>
                </div>`;
            }

            // Show "File Dispute" button for Operators if no dispute exists or it was rejected (optional, usually just if none)
            if (!isAdmin && !r.disputeStatus) {
                 disputeHtml += `<div id="file-dispute-container">
                    <button onclick="window.openDisputeForm()" id="btn-file-dispute" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11" /></svg>
                        File a Dispute for this record
                    </button>
                    <div id="dispute-input-container" class="hidden mt-3 space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100 animate-in fade-in slide-in-from-top-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block">Reason for Dispute</label>
                        <textarea id="dispute-reason-text" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" rows="3" placeholder="Explain why this call-out is invalid..."></textarea>
                        <div class="flex gap-2">
                            <button onclick="window.submitDispute(${index})" class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-100">Submit Dispute</button>
                            <button onclick="document.getElementById('dispute-input-container').classList.add('hidden'); document.getElementById('btn-file-dispute').classList.remove('hidden');" class="px-4 py-2 bg-white border border-slate-200 text-slate-500 text-xs font-bold rounded-lg hover:bg-slate-50">Cancel</button>
                        </div>
                    </div>
                 </div>`;
            }

            disputeUI.innerHTML = disputeHtml;

            const img = document.getElementById('view-image');
            const noImg = document.getElementById('view-no-image');
            if(r.proof) {
                img.src = r.proof;
                img.classList.remove('hidden');
                noImg.classList.add('hidden');
            } else {
                img.src = '';
                img.classList.add('hidden');
                noImg.classList.remove('hidden');
            }

            // Bind Edit Button
            const editBtn = document.getElementById('view-edit-btn');
            editBtn.onclick = function() {
                toggleModal('view-record-modal', false);
                openCalloutModal(index, true); // Open in Edit Mode
            };

            toggleModal('view-record-modal', true);
        };

        // NEW: Dispute Functions
        window.openDisputeForm = function() {
            document.getElementById('dispute-input-container').classList.remove('hidden');
            document.getElementById('btn-file-dispute').classList.add('hidden');
        };

        window.submitDispute = async function(index) {
            const reason = document.getElementById('dispute-reason-text').value.trim();
            if (!reason) {
                if(window.showToast) window.showToast("Please enter a reason.");
                return;
            }
            
            const confirmed = await AppModal.show("Submit Dispute", "Are you sure you want to dispute this record?", "confirm");
            if (!confirmed) return;

            // Update record status to pending
            const r = window.records[index];
            const updates = {
                disputeStatus: 'pending',
                disputeReason: reason,
                disputeDate: Date.now()
            };

            // Optimistic Update
            Object.assign(r, updates);
            
            // Save to Firebase
            if (window.updateFirebaseRecord && r.id) {
                await window.updateFirebaseRecord(r.id, updates);
            }
            
            if(window.showToast) window.showToast("Dispute submitted for review.");
            window.viewRecord(index); // Refresh view
        };

        window.resolveDispute = async function(index, isApproved) {
            const action = isApproved ? "Approve" : "Reject";
            const confirmed = await AppModal.show(`${action} Dispute`, `Are you sure you want to ${action.toLowerCase()} this dispute?`, "confirm");
            if (!confirmed) return;

            const r = window.records[index];
            const updates = {
                disputeStatus: isApproved ? 'approved' : 'rejected',
                isDisputed: isApproved // IMPORTANT: This triggers the void logic in stats
            };

            // Optimistic Update
            Object.assign(r, updates);

            // Save to Firebase
            if (window.updateFirebaseRecord && r.id) {
                await window.updateFirebaseRecord(r.id, updates);
            }

            if(window.showToast) window.showToast(`Dispute ${isApproved ? 'Approved' : 'Rejected'}`);
            window.viewRecord(index); // Refresh view
            // Also refresh background lists if needed
            if(window.renderAll) window.renderAll();
        };

        function openCalloutModal(editIdx = -1, forceEdit = false) {
            try {
                if (!window.isInitialized || !customSelects.brand) { initSearchSelects(); window.isInitialized = true; }
                const form = document.getElementById('callout-form');
                if (!form) { console.error("Form not found!"); return; } // Safety

                const submitBtn = document.getElementById('modal-submit-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                const title = document.getElementById('modal-title');
                
                const editIndexEl = document.getElementById('edit-index');
                if(editIndexEl) editIndexEl.value = editIdx;
                
                form.reset();
                
                // Helper to set editable state (Always editable in this function now)
                const setEditable = () => {
                    const elements = form.querySelectorAll('input, textarea, select, button');
                    elements.forEach(el => {
                        el.disabled = false;
                        el.classList.remove('bg-slate-100', 'text-slate-500');
                    });
                    document.querySelectorAll('.custom-search-select').forEach(el => {
                        el.classList.remove('pointer-events-none', 'opacity-60', 'bg-slate-100');
                    });
                    submitBtn.classList.remove('hidden');
                    cancelBtn.innerText = "Cancel";
                };
                
                if (editIdx > -1 && editIdx < window.records.length) {
                    const r = window.records[editIdx];
                    form.dataset.recordId = r.id; 
                    title.innerText = "Revise Entry"; // Always "Revise" if editIdx exists here
                    
                    const dtEl = document.getElementById('form-datetime');
                    if(dtEl && r.datetime) dtEl.value = r.datetime;
                    
                    // Set Dispute Checkbox safely
                    const disputeEl = document.getElementById('form-disputed');
                    if(disputeEl) disputeEl.checked = !!r.isDisputed;

                    if(customSelects.brand) customSelects.brand.setValue(r.brand);
                    if(customSelects.reporter) customSelects.reporter.setValue(r.who);
                    
                    let lolVal = Array.isArray(r.lol) ? r.lol : (r.lol ? [r.lol] : []);
                    if(customSelects.lol) customSelects.lol.setValue(lolVal);
                    refreshOperatorSelect(lolVal);
                    
                    let loVal = Array.isArray(r.lo) ? r.lo : (r.lo ? [r.lo] : []);
                    if(customSelects.lo) customSelects.lo.setValue(loVal);
                    
                    const reasonEl = document.getElementById('form-reason');
                    if(reasonEl) reasonEl.value = r.reason || '';
                    
                    const remarksEl = document.getElementById('form-remarks');
                    if(remarksEl) remarksEl.value = r.remarks || '';
                    
                    setEditable();
                } else {
                    delete form.dataset.recordId;
                    title.innerText = "New Call-Out Log";
                    
                    const dtEl = document.getElementById('form-datetime');
                    if(dtEl) dtEl.value = getPHTISOString();
                    
                    const disputeEl = document.getElementById('form-disputed');
                    if(disputeEl) disputeEl.checked = false; // Reset checkbox for new
                    
                    if(customSelects.brand) customSelects.brand.setValue('');
                    if(customSelects.reporter) customSelects.reporter.setValue('');
                    if(customSelects.lol) customSelects.lol.setValue([]);
                    if(customSelects.lo) customSelects.lo.setValue([]);
                    
                    setEditable();
                }
                toggleModal('callout-modal', true);
            } catch (e) { console.error("Open Modal Error:", e); alert("Issue opening form. Please refresh."); }
        }

        document.getElementById('callout-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const editIdx = parseInt(document.getElementById('edit-index').value);
            const isEdit = editIdx > -1;
            const brandVal = customSelects.brand.getValue();
            const reporterVal = customSelects.reporter.getValue();
            const lolVal = customSelects.lol.getValue(); // Array
            const loVal = customSelects.lo.getValue(); // Array
            
            const disputeEl = document.getElementById('form-disputed');
            const isDisputed = disputeEl ? disputeEl.checked : false;

            // Validation for arrays
            const isLolValid = Array.isArray(lolVal) ? lolVal.length > 0 : !!lolVal;
            const isLoValid = Array.isArray(loVal) ? loVal.length > 0 : !!loVal;

            if(!brandVal || !reporterVal || !isLolValid || !isLoValid) { 
                await AppModal.show("Incomplete", "Please fill all fields.", 'alert'); return; 
            }
            const confirmed = await AppModal.show("Confirm", `Save this record?`, 'confirm');
            if(!confirmed) return;

            const formData = new FormData(e.target);
            const proofFile = document.getElementById('form-proof').files[0];
            let proofBase64 = null;
            if (isEdit && window.records[editIdx]) proofBase64 = window.records[editIdx].proof;
            if (proofFile) proofBase64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result); rd.readAsDataURL(proofFile); });

            const recordData = {
                datetime: formData.get('datetime'),
                brand: brandVal,
                who: reporterVal,
                reason: formData.get('reason'),
                lo: loVal, 
                lol: lolVal,
                remarks: formData.get('remarks'),
                proof: proofBase64,
                isDisputed: isDisputed, // Save Dispute State
                timestamp: isEdit ? window.records[editIdx].timestamp : Date.now()
            };

            // If admin manually toggles dispute in edit form, ensure we reset or set disputeStatus accordingly if needed, 
            // but usually manual override is stronger. We'll leave disputeStatus as is unless we want manual uncheck to clear it.
            // For now, let's keep it simple.

            try {
                if (isEdit && window.updateFirebaseRecord && form.dataset.recordId) await window.updateFirebaseRecord(form.dataset.recordId, recordData);
                else if (window.addFirebaseRecord) await window.addFirebaseRecord(recordData);
                
                e.target.reset(); 
                toggleModal('callout-modal', false);
            } catch (err) {
                console.error("Save Error:", err);
                if(window.showToast) window.showToast("Error occurred during save.");
            }
        };

        function renderAll() {
            renderDashboard();
            renderLogTabs();
            renderLogs();
            renderSettings();
            initSearchSelects(); // Ensure dropdowns have latest data
            populateSelects();
        }

        function populateSelects() {
            if(!window.config.lols) return;
            const sortedLeads = [...window.config.lols].sort();
            const newLoLead = document.getElementById('new-lo-lead');
            if(newLoLead) newLoLead.innerHTML = '<option value="">Select Team Lead</option>' + sortedLeads.map(l => `<option value="${l}">${l}</option>`).join('');
            const editOpLead = document.getElementById('edit-op-lead');
            if(editOpLead) editOpLead.innerHTML = sortedLeads.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function renderDashboard() {
            const filterType = document.getElementById('dashboard-filter') ? document.getElementById('dashboard-filter').value : 'overall';
            const monthPickerValue = document.getElementById('dashboard-month-picker') ? document.getElementById('dashboard-month-picker').value : '';
            const now = new Date();
            let targetMonth, targetYear;
            let filterLabel = 'Overall';
            
            // Base Filter by Date
            let allDateFilteredRecords = window.records;

            if (filterType === 'current_month') {
                targetMonth = now.getMonth(); targetYear = now.getFullYear(); filterLabel = 'This Month';
                allDateFilteredRecords = window.records.filter(r => { const d = new Date(r.datetime); return d.getMonth() === targetMonth && d.getFullYear() === targetYear; });
            } else if (filterType === 'specific_month' && monthPickerValue) {
                const [yearStr, monthStr] = monthPickerValue.split('-');
                targetYear = parseInt(yearStr); targetMonth = parseInt(monthStr) - 1; 
                const dateObj = new Date(targetYear, targetMonth);
                filterLabel = dateObj.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                allDateFilteredRecords = window.records.filter(r => { const d = new Date(r.datetime); return d.getMonth() === targetMonth && d.getFullYear() === targetYear; });
            } else { filterLabel = 'Lifetime Total'; }

            // FILTER OUT DISPUTED RECORDS FOR STATS
            const validRecords = allDateFilteredRecords.filter(r => !r.isDisputed);

            document.getElementById('label-total').innerText = filterLabel;
            document.getElementById('stat-total').innerText = validRecords.length;
            
            // Today's Active (Valid Only)
            document.getElementById('stat-today').innerText = validRecords.filter(r => new Intl.DateTimeFormat('en-US', {timeZone: 'Asia/Manila'}).format(new Date(r.datetime)) === new Intl.DateTimeFormat('en-US', {timeZone: 'Asia/Manila'}).format(now)).length;
            
            document.getElementById('coaching-period-label').innerText = filterType === 'overall' ? 'Overall' : filterLabel;
            
            // Stats (Valid Only)
            if(validRecords.length > 0) {
                const brands = validRecords.map(r => r.brand);
                const mostBrand = brands.sort((a,b) => brands.filter(v => v===a).length - brands.filter(v => v===b).length).pop();
                document.getElementById('stat-brand').innerText = mostBrand || '-';
                const reporters = validRecords.map(r => r.who);
                const mostWho = reporters.sort((a,b) => reporters.filter(v => v===a).length - reporters.filter(v => v===b).length).pop();
                document.getElementById('stat-who').innerText = mostWho || '-';
            } else {
                document.getElementById('stat-brand').innerText = '-'; document.getElementById('stat-who').innerText = '-';
            }

            // Coaching (Valid Only)
            const coachingContainer = document.getElementById('coaching-list');
            if(coachingContainer) {
                const operatorCounts = {};
                validRecords.forEach(r => { 
                    // Handle array of operators in a single record
                    const operators = Array.isArray(r.lo) ? r.lo : [r.lo];
                    operators.forEach(opName => {
                         if(opName) operatorCounts[opName] = (operatorCounts[opName] || 0) + 1;
                    });
                });
                const sortedOperators = Object.entries(operatorCounts).sort(([,a], [,b]) => b - a).slice(0, 6);
                coachingContainer.innerHTML = '';
                if(sortedOperators.length === 0) {
                    coachingContainer.innerHTML = `<div class="col-span-full text-center text-slate-400 text-xs italic py-4">No violations recorded</div>`;
                } else {
                    const maxCount = sortedOperators[0][1];
                    sortedOperators.forEach(([name, count], index) => {
                        const percentage = (count / maxCount) * 100;
                        const barColor = index === 0 ? 'bg-red-500' : (index === 1 ? 'bg-orange-400' : 'bg-blue-400');
                        coachingContainer.innerHTML += `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-6 h-6 rounded-full bg-white flex items-center justify-center text-[10px] font-black text-slate-500 shadow-sm">${index + 1}</div><div class="flex-1"><div class="flex justify-between items-center mb-1"><span class="text-xs font-bold text-slate-700 truncate max-w-[100px]">${name}</span><span class="text-[10px] font-black text-slate-400">${count} Calls</span></div><div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden"><div class="h-full ${barColor} rounded-full" style="width: ${percentage}%"></div></div></div></div>`;
                    });
                }
            }

            // Recent Table (Shows ALL records, even disputed, but visually marked)
            const recentBody = document.getElementById('recent-table-body');
            recentBody.innerHTML = '';
            // Use allDateFilteredRecords (includes disputed) or window.records for truly recent irrespective of filter
            // Usually "Recent" means recent global activity, so let's use window.records
            const recentToShow = window.records.slice().sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 8);
            
            if(recentToShow.length === 0) {
                recentBody.innerHTML = `<tr><td colspan="5" class="px-8 py-4 text-center text-xs text-slate-400 italic">No records found</td></tr>`;
            } else {
                recentToShow.forEach(r => {
                    const originalIdx = window.records.findIndex(rec => rec.id === r.id); 
                    const date = new Date(r.datetime).toLocaleString('en-US', { timeZone: 'Asia/Manila', dateStyle: 'medium', timeStyle: 'short' });
                    // Format LO/LOL array for display
                    const displayLo = Array.isArray(r.lo) ? r.lo.join(', ') : r.lo;
                    const displayLol = Array.isArray(r.lol) ? r.lol.join(', ') : r.lol;
                    
                    const rowClass = r.isDisputed ? 'bg-red-50/50' : '';
                    const strikeClass = r.isDisputed ? 'line-through text-red-300' : 'text-slate-900';
                    const textClass = r.isDisputed ? 'text-red-300' : 'text-slate-600';
                    
                    recentBody.innerHTML += `<tr class="clickable-row ${rowClass}" onclick="viewRecord(${originalIdx})"><td class="px-8 py-5 font-bold ${strikeClass} whitespace-nowrap">${date} ${r.isDisputed ? '<span class="ml-2 bg-red-100 text-red-500 text-[8px] px-1.5 py-0.5 rounded no-underline inline-block">VOID</span>' : ''}</td><td class="px-8 py-5 font-medium ${textClass}">${r.brand}</td><td class="px-8 py-5"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-black text-[9px] tracking-widest uppercase whitespace-nowrap ${r.isDisputed ? 'opacity-50' : ''}">${r.who}</span></td><td class="px-8 py-5 text-slate-400 font-medium italic truncate max-w-[150px] ${r.isDisputed ? 'opacity-50' : ''}">"${r.reason}"</td><td class="px-8 py-5 text-right whitespace-nowrap ${r.isDisputed ? 'opacity-50' : ''}"><div class="text-[10px] font-black text-slate-900 uppercase tracking-tighter truncate max-w-[100px]" title="${displayLol}">${displayLol}</div><div class="text-[9px] font-bold text-slate-400 uppercase truncate max-w-[100px] inline-block" title="${displayLo}">${displayLo}</div></td></tr>`;
                });
            }
        }

        function renderLogTabs() {
            const container = document.getElementById('lol-filter-container');
            const lols = ['All', ...[...window.config.lols].sort()];
            container.innerHTML = '';
            
            // Re-apply Date Filter Logic for accurate counts
            const dateFilterType = document.getElementById('log-date-filter')?.value || 'overall';
            const dateFilterValue = document.getElementById('log-month-picker')?.value;
            
            let recordsToCount = window.records;
            if (dateFilterType === 'current_month') {
                const now = new Date();
                const targetMonth = now.getMonth();
                const targetYear = now.getFullYear();
                recordsToCount = recordsToCount.filter(r => {
                    const d = new Date(r.datetime);
                    return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                });
            } else if (dateFilterType === 'specific_month' && dateFilterValue) {
                const [yearStr, monthStr] = dateFilterValue.split('-');
                const targetYear = parseInt(yearStr);
                const targetMonth = parseInt(monthStr) - 1;
                recordsToCount = recordsToCount.filter(r => {
                    const d = new Date(r.datetime);
                    return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                });
            }

            // Exclude disputed from Tab Counts as well? Usually better to just count them as 'records' but filtering in dashboard.
            // Let's keep them in the count but maybe show valid count. For simplicity, just count existing records in the list.

            lols.forEach(lol => {
                const count = lol === 'All' ? recordsToCount.length : recordsToCount.filter(r => {
                     // Check if r.lol (string or array) includes this lead
                     if (Array.isArray(r.lol)) return r.lol.includes(lol);
                     return r.lol === lol;
                }).length;
                const isActive = window.currentLogFilter === lol;
                container.innerHTML += `<button onclick="setLogFilter('${lol}')" class="whitespace-nowrap px-6 py-3 rounded-2xl text-xs font-black transition-all ${isActive ? 'bg-blue-600 text-white shadow-xl shadow-blue-50' : 'bg-white text-slate-400 hover:bg-slate-50 border border-slate-100'}">${lol} <span class="${isActive ? 'text-blue-100' : 'text-slate-300'} ml-2">${count}</span></button>`;
            });
        }

        function setLogFilter(lol) { window.currentLogFilter = lol; renderLogTabs(); renderLogs(); }

        function renderLogs() {
            const body = document.getElementById('full-log-body');
            body.innerHTML = '';
            
            // 1. Date Filtering
            const dateFilterType = document.getElementById('log-date-filter')?.value || 'overall';
            const dateFilterValue = document.getElementById('log-month-picker')?.value;

            let recordsToRender = window.records;

            if (dateFilterType === 'current_month') {
                const now = new Date();
                const targetMonth = now.getMonth();
                const targetYear = now.getFullYear();
                recordsToRender = recordsToRender.filter(r => {
                    const d = new Date(r.datetime);
                    return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                });
            } else if (dateFilterType === 'specific_month' && dateFilterValue) {
                const [yearStr, monthStr] = dateFilterValue.split('-');
                const targetYear = parseInt(yearStr);
                const targetMonth = parseInt(monthStr) - 1;
                recordsToRender = recordsToRender.filter(r => {
                    const d = new Date(r.datetime);
                    return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                });
            }

            // 2. LOL Filtering
            const filtered = window.currentLogFilter === 'All' 
                ? recordsToRender 
                : recordsToRender.filter(r => {
                     if (Array.isArray(r.lol)) return r.lol.includes(window.currentLogFilter);
                     return r.lol === window.currentLogFilter;
                });

            if(filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="px-6 py-24 text-center text-slate-300 font-bold italic">No log entries found.</td></tr>`;
                return;
            }

            // 3. Sorting (Latest First)
            filtered.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

            let currentGroup = '';

            filtered.forEach((r) => {
                const idx = window.records.indexOf(r);
                const dateObj = new Date(r.datetime);
                const groupStr = dateObj.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                const date = dateObj.toLocaleString('en-US', { timeZone: 'Asia/Manila', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                const displayLo = Array.isArray(r.lo) ? r.lo.join(', ') : r.lo;
                const displayLol = Array.isArray(r.lol) ? r.lol.join(', ') : r.lol;

                if (groupStr !== currentGroup) {
                    currentGroup = groupStr;
                    body.innerHTML += `
                        <tr class="bg-slate-100/80 border-b border-slate-200">
                            <td colspan="5" class="px-6 py-3 text-xs font-black text-slate-500 uppercase tracking-widest sticky top-0 z-10">
                                ${currentGroup}
                            </td>
                        </tr>
                    `;
                }

                // Disputed Styling
                const rowStyle = r.isDisputed ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-white';
                const opacityStyle = r.isDisputed ? 'opacity-60 grayscale' : '';
                const disputeBadge = r.isDisputed ? '<div class="mb-1"><span class="bg-red-500 text-white text-[9px] font-black px-2 py-0.5 rounded">VOIDED</span></div>' : '';

                body.innerHTML += `
                    <tr class="group transition-colors border-b border-slate-50 last:border-0 ${rowStyle}">
                        <td class="px-6 py-6 ${opacityStyle}">
                            ${r.proof ? `<img src="${r.proof}" class="h-14 w-14 rounded-2xl object-cover cursor-pointer hover:scale-110 shadow-sm transition-all" onclick="viewImage('${r.proof}')">` : '<div class="h-14 w-14 rounded-2xl bg-slate-50 flex items-center justify-center text-[9px] font-black text-slate-300 uppercase text-center leading-none">No Img</div>'}
                        </td>
                        <td class="px-6 py-6">
                            ${disputeBadge}
                            <div class="font-bold text-slate-900 ${r.isDisputed ? 'line-through text-red-900' : ''}">${date}</div>
                            <div class="text-blue-600 font-black text-[10px] uppercase mt-1 tracking-widest ${r.isDisputed ? 'text-red-400' : ''}">${r.who}</div>
                        </td>
                        <td class="px-6 py-6 ${opacityStyle}">
                            <div class="font-bold text-slate-900">${r.brand}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-tighter truncate max-w-[150px]">${r.reason}</div>
                        </td>
                        <td class="px-6 py-6 ${opacityStyle}">
                            <div class="text-[10px] font-black text-indigo-500 uppercase tracking-widest truncate max-w-[120px]" title="${displayLol}">${displayLol}</div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase truncate max-w-[120px]" title="${displayLo}">${displayLo}</div>
                            <div class="text-xs italic text-slate-500 font-medium mt-1 truncate max-w-[150px]">"${r.remarks || 'No remarks'}"</div>
                        </td>
                        <td class="px-6 py-6 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="viewRecord(${idx})" class="p-3 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                </button>
                                <button onclick="deleteRecord(${idx})" class="p-3 bg-red-50 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all admin-only">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        // Settings Renderer
        function renderSettings() {
            const renderList = (type, targetId) => {
                const list = document.getElementById(targetId);
                list.innerHTML = '';
                [...window.config[type]].sort().forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-slate-50 p-4 rounded-2xl group hover:bg-white hover:ring-2 hover:ring-slate-100 transition-all";
                    li.innerHTML = `<span class="font-bold text-sm text-slate-700">${item}</span>`;
                    const btn = document.createElement('button');
                    btn.className = "text-red-300 hover:text-red-600 font-bold px-2 text-xl";
                    btn.innerHTML = "&times;";
                    btn.onclick = () => removeItem(type, item);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            };

            renderList('brands', 'list-brands');
            renderList('lols', 'list-lols');
            renderList('ams', 'list-ams');
            renderList('als', 'list-als');
            renderList('hosts', 'list-hosts');
            renderList('qas', 'list-qas');

            const ocontainer = document.getElementById('list-los');
            ocontainer.innerHTML = '';
            [...window.config.lols].sort().forEach(lead => {
                const leadOperators = [...window.config.los].filter(o => o.lead === lead).sort((a,b) => a.name.localeCompare(b.name));
                if (leadOperators.length > 0) {
                    let group = document.createElement('div');
                    group.className = "space-y-4";
                    group.innerHTML = `<h4 class="text-[10px] font-black text-slate-300 uppercase tracking-widest pl-2">${lead}</h4><div class="grid grid-cols-1 gap-3">`;
                    leadOperators.forEach(o => {
                        let brandTags = (o.brands || []).map(b => `<span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-[9px] font-bold uppercase tracking-wider">${b}</span>`).join('');
                        let item = document.createElement('div');
                        item.className = "flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm gap-4";
                        item.innerHTML = `<div class="flex-1"><div class="font-bold text-slate-900">${o.name}</div><div class="flex flex-wrap gap-1 mt-2">${brandTags || '<span class="text-xs text-slate-300 italic">No brands assigned</span>'}</div></div>`;
                        let acts = document.createElement('div');
                        acts.className = "flex items-center gap-3 w-full sm:w-auto";
                        let editBtn = document.createElement('button');
                        editBtn.className = "p-2.5 bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white rounded-xl transition-all font-bold";
                        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>`;
                        editBtn.onclick = () => openEditOperatorModal(o.name);
                        let del = document.createElement('button');
                        del.className = "p-2.5 bg-red-50 text-red-400 hover:bg-red-500 hover:text-white rounded-xl transition-all font-bold";
                        del.innerHTML = "&times;";
                        del.onclick = () => removeItem('los', o.name);
                        acts.appendChild(editBtn); acts.appendChild(del);
                        item.appendChild(acts); group.querySelector('div').appendChild(item);
                    });
                    ocontainer.appendChild(group);
                }
            });
        }

        // --- Other Helpers (ToggleModal, AppModal, etc. same as above) ---
        function openEditOperatorModal(name) {
            const op = window.config.los.find(o => o.name === name);
            if(!op) return;
            document.getElementById('edit-op-original-name').value = op.name;
            document.getElementById('edit-op-name').value = op.name;
            const leadSelect = document.getElementById('edit-op-lead');
            leadSelect.innerHTML = window.config.lols.map(l => `<option value="${l}">${l}</option>`).join('');
            leadSelect.value = op.lead;
            const brandsContainer = document.getElementById('edit-op-brands');
            brandsContainer.innerHTML = '';
            [...window.config.brands].sort().forEach(b => {
                const isChecked = (op.brands || []).includes(b);
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-100 hover:border-blue-200 transition-colors cursor-pointer";
                div.innerHTML = `<input type="checkbox" value="${b}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"><span class="text-xs font-bold text-slate-700 truncate select-none">${b}</span>`;
                div.onclick = (e) => { if (e.target.tagName !== 'INPUT') { const cb = div.querySelector('input'); cb.checked = !cb.checked; } };
                brandsContainer.appendChild(div);
            });
            toggleModal('edit-operator-modal', true);
        }

        async function saveOperatorChanges() {
            const originalName = document.getElementById('edit-op-original-name').value;
            const newName = document.getElementById('edit-op-name').value.trim();
            const newLead = document.getElementById('edit-op-lead').value;
            const selectedBrands = Array.from(document.querySelectorAll('#edit-op-brands input:checked')).map(cb => cb.value);
            if (!newName) { if(window.showToast) window.showToast("Name is required"); return; }
            const idx = window.config.los.findIndex(o => o.name === originalName);
            if (idx === -1) return;
            if (newName !== originalName && window.config.los.some(o => o.name === newName)) { if(window.showToast) window.showToast("Name taken"); return; }
            const confirmed = await AppModal.show("Update Operator", `Save changes?`, 'confirm');
            if (confirmed) {
                window.config.los[idx] = { name: newName, lead: newLead, brands: selectedBrands };
                if(window.saveFirebaseConfig) await window.saveFirebaseConfig(window.config);
                toggleModal('edit-operator-modal', false); if(window.showToast) window.showToast("Operator updated");
            }
        }

        async function removeItem(type, id) {
            const confirmed = await AppModal.show("Delete Item", `Delete "${id}"?`, 'confirm');
            if(confirmed) {
                if(['brands', 'lols', 'ams', 'als', 'hosts', 'qas'].includes(type)) window.config[type] = window.config[type].filter(item => item !== id);
                else if(type === 'los') window.config.los = window.config.los.filter(o => o.name !== id);
                if(window.saveFirebaseConfig) await window.saveFirebaseConfig(window.config);
                if(window.showToast) window.showToast("Item deleted");
            }
        }

        async function addItem(type, inputId) {
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if(!val) return;
            if(window.config[type].includes(val)) { if(window.showToast) window.showToast("Exists already"); return; }
            
            // Check for duplicate in personnel roles
             if(['ams', 'als', 'hosts', 'qas'].includes(type)) {
                const foundRole = roleCategories.find(cat => window.config[cat.id].includes(val));
                if (foundRole) {
                    await AppModal.show("Duplicate Entry", `"${val}" is already registered under ${foundRole.label}.`, 'alert');
                    return;
                }
            }

            const confirmed = await AppModal.show("Add Entry", `Register "${val}"?`, 'confirm');
            if(confirmed) {
                window.config[type].push(val);
                input.value = '';
                if(window.saveFirebaseConfig) await window.saveFirebaseConfig(window.config);
                if(window.showToast) window.showToast("Entry registered");
            }
        }

        async function addOperatorRelationship() {
            const name = document.getElementById('new-lo-name').value.trim();
            const lead = document.getElementById('new-lo-lead').value;
             const selectedBrands = Array.from(document.querySelectorAll('#brand-checklist input:checked')).map(cb => cb.value);

            if(name && lead) {
                if(window.config.los.some(o => o.name === name)) { if(window.showToast) window.showToast("Operator exists"); return; }
                const confirmed = await AppModal.show("Create Operator", `Add "${name}"?`, 'confirm');
                if(confirmed) {
                    window.config.los.push({ name, lead, brands: selectedBrands });
                    document.getElementById('new-lo-name').value = '';
                     document.querySelectorAll('#brand-checklist input').forEach(cb => cb.checked = false);
                    if(window.saveFirebaseConfig) await window.saveFirebaseConfig(window.config);
                    if(window.showToast) window.showToast("Operator created");
                }
            } else { if(window.showToast) window.showToast("Fill all fields"); }
        }

        async function deleteRecord(index) {
            const rec = window.records[index];
            if(!rec) return;
            const confirmed = await AppModal.show("Delete Record", "Permanently delete this record?", 'confirm');
            if(confirmed) {
                if(window.deleteFirebaseRecord && rec.id) await window.deleteFirebaseRecord(rec.id);
                else { window.records.splice(index, 1); saveRecords(); renderAll(); }
            }
        }
        
        // Export to Excel function
        window.exportToExcel = async function() {
            try {
                if(window.records.length === 0) {
                    if(window.showToast) window.showToast("No records to export.");
                    return;
                }
                
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Call-out Logs');
                
                worksheet.columns = [
                    { header: 'Date & Time', key: 'datetime', width: 20 },
                    { header: 'Brand', key: 'brand', width: 15 },
                    { header: 'Reporter', key: 'who', width: 20 },
                    { header: 'Reason', key: 'reason', width: 40 },
                    { header: 'Lead', key: 'lol', width: 20 },
                    { header: 'Operator', key: 'lo', width: 20 },
                    { header: 'Remarks', key: 'remarks', width: 30 },
                    { header: 'Image', key: 'image', width: 15 }
                ];
                
                // Add rows
                for (const record of window.records) {
                    const rowData = {
                        datetime: new Date(record.datetime).toLocaleString('en-US', { timeZone: 'Asia/Manila' }),
                        brand: record.brand,
                        who: record.who,
                        reason: record.reason,
                        lol: Array.isArray(record.lol) ? record.lol.join(', ') : record.lol,
                        lo: Array.isArray(record.lo) ? record.lo.join(', ') : record.lo,
                        remarks: record.remarks || ''
                    };
                    const row = worksheet.addRow(rowData);
                    
                    if (record.proof) {
                        try {
                            const imageId = workbook.addImage({
                                base64: record.proof,
                                extension: 'png',
                            });
                            worksheet.addImage(imageId, {
                                tl: { col: 7, row: row.number - 1 },
                                ext: { width: 50, height: 50 }
                            });
                            row.height = 40;
                        } catch (err) {
                            console.error("Error adding image to excel", err);
                        }
                    }
                }
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, `Callout_Tracker_${new Date().toISOString().slice(0,10)}.xlsx`);
                if(window.showToast) window.showToast("Export successful!");
            } catch (e) {
                console.error("Export Error:", e);
                if(window.showToast) window.showToast("Export failed.");
            }
        };

        // View Image
        function viewImage(src) {
            const win = window.open("");
            win.document.write(`<body style="margin:0;background:#0f172a;display:flex;align-items:center;justify-content:center;height:100vh;"><img src="${src}" style="max-width:95%;max-height:95%;border-radius:24px;box-shadow:0 0 50px rgba(0,0,0,0.5);"></body>`);
        }
        
        function filterBrandCheckboxes(inputId, containerId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toLowerCase();
            const container = document.getElementById(containerId);
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const span = item.querySelector('span');
                if (span) {
                    const text = span.textContent || span.innerText;
                    if (text.toLowerCase().indexOf(filter) > -1) { item.style.display = "flex"; } 
                    else { item.style.display = "none"; }
                }
            }
        }
        
        function handleDashboardFilterChange() {
            const filterType = document.getElementById('dashboard-filter').value;
            const monthPicker = document.getElementById('dashboard-month-picker');
            if (filterType === 'specific_month') {
                monthPicker.classList.remove('hidden');
                if (!monthPicker.value) {
                    const now = new Date();
                    monthPicker.value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                }
            } else { monthPicker.classList.add('hidden'); }
            renderDashboard();
        }
        
        function switchSettingsTab(tab) {
            document.querySelectorAll('.setting-tab').forEach(t => { t.classList.remove('bg-blue-50', 'text-blue-600'); t.classList.add('text-slate-500'); });
            const act = document.getElementById(`tab-${tab}`);
            if(act) { act.classList.remove('text-slate-500'); act.classList.add('bg-blue-50', 'text-blue-600'); }
            document.querySelectorAll('.setting-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`set-${tab}`).classList.remove('hidden');
        }
        
        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active-tab'));
            const map = ['dashboard', 'record-log', 'settings'];
            const idx = map.indexOf(id);
            if(idx !== -1) document.querySelectorAll('.nav-link')[idx].classList.add('active-tab');
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('mobile-active'));
            const mob = document.getElementById(`mob-${id}`);
            if(mob) mob.classList.add('mobile-active');
            if(id === 'record-log') { renderLogTabs(); renderLogs(); }
            if(id === 'dashboard') { renderDashboard(); }
        }
        
        // Populate brand checklist for new operator initially
        function populateBrandChecklist() {
            const container = document.getElementById('brand-checklist');
            if (!container) return;
            container.innerHTML = '';
            if (window.config && window.config.brands) {
                [...window.config.brands].sort().forEach(b => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-blue-200 transition-colors cursor-pointer checkbox-item";
                    div.innerHTML = `<input type="checkbox" value="${b}"><span class="text-xs font-bold text-slate-700 truncate select-none">${b}</span>`;
                    div.onclick = (e) => { if (e.target.tagName !== 'INPUT') { const cb = div.querySelector('input'); cb.checked = !cb.checked; } };
                    container.appendChild(div);
                });
            }
        }
        
        // Hook into existing init
        const originalInit = window.onload;
        window.onload = () => {
             if (originalInit) originalInit();
             populateBrandChecklist();
        };

        // Re-run populate when brands change (hook into renderSettings)
        const originalRenderSettings = renderSettings;
        renderSettings = function() {
            originalRenderSettings();
            populateBrandChecklist();
        };

    </script>
</body>
</html>